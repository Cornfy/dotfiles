#!/bin/bash

# --- ä½¿ç”¨ç»å¯¹è·¯å¾„ ---
MPC_CMD="/usr/bin/mpc"

# 1. æ£€æŸ¥ MPD çŠ¶æ€
if ! $MPC_CMD status &>/dev/null; then
    echo "{}"
    exit 0
fi

# 2. è·å–æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯
status_output=$($MPC_CMD status 2>/dev/null)
player_status=$(echo "$status_output" | awk 'NR==2 {print $1}' | tr -d '[]')

if [[ "$player_status" == "stopped" || -z "$player_status" ]]; then
    echo "{}"
    exit 0
fi

# 3. è®¾ç½®å›¾æ ‡å’Œ CSS Class
if [[ "$player_status" == "playing" ]]; then
    icon="ï‹"
    class="playing"
else # Paused
    icon="ïŒ"
    class="paused"
fi

# 4. å‡†å¤‡ Bar ä¸Šæ˜¾ç¤ºçš„ 'text'
song_title=$($MPC_CMD -f "%title%" current 2>/dev/null)
text="$icon $(echo $song_title | cut -c1-30)"

# 5. å‡†å¤‡æ‚¬åœæç¤ºçš„ 'tooltip'
full_song_info=$($MPC_CMD -f "%artist% - %title%" current 2>/dev/null)
progress=$(echo "$status_output" | awk 'NR==2 {print $3, $4}')
volume=$(echo "$status_output" | awk -F'volume:' 'NR==3 {print $2}' | awk '{print $1}')
tooltip=$(printf "ğŸµ %s\n\nï€— %s\nï€¨ %s" \
    "$full_song_info" \
    "$progress" \
    "$volume")

# ================================================================
#               å…¨æ–°çš„ã€æ›´å¯é çš„è½¬ä¹‰å‡½æ•°
# ================================================================
json_escape() {
    local input="$1"
    # 1. è½¬ä¹‰åæ–œæ 
    local escaped="${input//\\/\\\\}"
    # 2. è½¬ä¹‰åŒå¼•å·
    escaped="${escaped//\"/\\\"}"
    # 3. å°†çœŸå®çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸º \n æ–‡æœ¬
    escaped="${escaped//$'\n'/\\n}"
    echo -n "$escaped"
}
# ================================================================

# 6. ä½¿ç”¨æ–°å‡½æ•°æ„å»º JSON å¹¶è¾“å‡º
text_escaped=$(json_escape "$text")
tooltip_escaped=$(json_escape "$tooltip")
class_escaped=$(json_escape "$class")

printf '{"text":"%s", "tooltip":"%s", "class":"%s"}\n' \
    "$text_escaped" \
    "$tooltip_escaped" \
    "$class_escaped"
