#!/bin/bash

# ============================================================
# é…ç½®åŒºåŸŸ
# ============================================================
SSH_USER="shell"
SSH_KEY="$HOME/.ssh/id_ed25519_oneplus12"
REMOTE_PATH="/storage/emulated/0"
MOUNT_POINT="$HOME/Mobile_Phone"

# ============================================================
# åŠŸèƒ½å‡½æ•°
# ============================================================

# å¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: $(basename "$0") [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -r, --run      çœŸæ­£æ‰§è¡ŒæŒ‚è½½æ“ä½œ (é»˜è®¤ä»…ä¸ºè¿æ¥æµ‹è¯•)"
    echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "è¯´æ˜: é»˜è®¤æƒ…å†µä¸‹ä»…æµ‹è¯•ç½‘ç»œè¿æ¥æ€§ï¼Œä¸æ‰§è¡Œå®é™…æŒ‚è½½ã€‚"
}

# è¯†åˆ«ç½‘ç»œç¯å¢ƒ
detect_network() {
    # æ¶æ„è¯´æ˜ï¼š
    # æ‰‹æœºè¿è¡Œç”± MagiskSSH æ¨¡å—æä¾›çš„ OpenSSH ï¼Œä»…ç›‘å¬åœ¨ 127.0.0.1:22
    # 7743: æ‰‹æœºç«¯ç½‘å…³ç›‘å¬çš„ Inbound ç«¯å£(ç”¨äº USB Rndis0 é«˜é€Ÿæ¥å…¥)ï¼Œç”±æ‰‹æœºç«¯ç½‘å…³è½¬å‘è‡³ 127.0.0.1:22
    # 22  : é€šè¿‡ Tailscale åˆ†é…çš„åŸŸå/IP æ­£å¸¸è®¿é—®ï¼Œç”±æ‰‹æœºç«¯ç½‘å…³è½¬å‘è‡³ 127.0.0.1:22

    local dev_name
    dev_name=$(ip -o link show | awk -F': ' '{print $2}' | grep -E '^(enp[0-9a-z]+u[0-9]+|usb[0-9]+)' | head -n 1)

    if [ -n "$dev_name" ]; then
        local rndis_ip=$(ip route show dev "$dev_name" 2>/dev/null | grep 'default' | awk '{print $3}' | head -n 1)
        if [ -n "$rndis_ip" ]; then
            SSH_HOST="$rndis_ip"
            SSH_PORT="7743"
            echo "ğŸ”Œ [USB æ¨¡å¼] ç›®æ ‡: $SSH_HOST:$SSH_PORT"
            return 0
        fi
    fi

    SSH_HOST="oneplus12"
    SSH_PORT="22"
    echo "ğŸŒ [ç½‘ç»œæ¨¡å¼] ç›®æ ‡: $SSH_HOST:$SSH_PORT"
}

# æ‰§è¡ŒæŒ‚è½½
do_mount() {
    local is_run_currently=$1
    
    # ç¡®ä¿æŒ‚è½½ç‚¹å­˜åœ¨
    mkdir -p "$MOUNT_POINT"

    # æ£€æŸ¥æ˜¯å¦å·²æŒ‚è½½
    if mountpoint -q "$MOUNT_POINT"; then
        echo "â„¹ï¸  æ‰‹æœºå·²åœ¨æŒ‚è½½çŠ¶æ€: $MOUNT_POINT"
        return 0
    fi

    if [ "$is_run_currently" != "true" ]; then
        echo "ğŸ” [æµ‹è¯•æ¨¡å¼] æ­£åœ¨å°è¯• SSH è¿æ¥æµ‹è¯•..."
        ssh -o ConnectTimeout=3 -p "$SSH_PORT" -i "$SSH_KEY" "$SSH_USER@$SSH_HOST" "exit" 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼ä½¿ç”¨ -r å‚æ•°å³å¯æ­£å¼æŒ‚è½½ã€‚"
        else
            echo "âŒ è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥[USB ç½‘ç»œå…±äº«]æ˜¯å¦å¼€å¯ï¼Œæˆ–æ£€æŸ¥ç½‘ç»œæ˜¯å¦é€šç•…ã€‚"
            return 1
        fi
        return 0
    fi

    echo "ğŸ“‚ æ­£åœ¨æŒ‚è½½è¿œç¨‹å­˜å‚¨ [$REMOTE_PATH] -> [$MOUNT_POINT]..."

    # SSHFS æŒ‚è½½å‚æ•°ä¼˜åŒ–
    # -o allow_other: æ³¨æ„éœ€è¦ /etc/fuse.conf å¼€å¯ user_allow_other
    # -o uid,gid: æ˜ç¡®æŒ‡å®šæœ¬åœ°ç”¨æˆ· IDï¼Œé¿å… Arch ä¸‹å‡ºç°â€œæƒé™æ‹’ç»â€
    sshfs "$SSH_USER@$SSH_HOST:$REMOTE_PATH" "$MOUNT_POINT" \
        -p "$SSH_PORT" -o IdentityFile="$SSH_KEY" \
        -o idmap=user \
        -o uid=$(id -u) \
        -o gid=$(id -g) \
        -o kernel_cache \
        -o auto_cache \
        -o reconnect \
        -o compression=no \
        -o ServerAliveInterval=15 \
        -o ServerAliveCountMax=3 \
        -o ConnectTimeout=5

    if [ $? -eq 0 ]; then
        echo "âœ… æŒ‚è½½æˆåŠŸï¼"
    else
        echo "âŒ æŒ‚è½½å¤±è´¥ã€‚"
        return 1
    fi
}

# ============================================================
# ä¸»å…¥å£
# ============================================================

main() {
    local run_mount=false

    case "$1" in
        -r|--run)
            run_mount=true
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        "")
            run_mount=false
            ;;
        *)
            echo "âŒ é”™è¯¯: æœªçŸ¥å‚æ•° '$1'"
            show_help
            exit 1
            ;;
    esac

    detect_network
    do_mount "$run_mount"
}

main "$@"
