#!/bin/bash

# ============================================================
# é…ç½®åŒºåŸŸ
# ============================================================
SSH_USER="root"
SSH_KEY="$HOME/.ssh/id_ed25519_oneplus12"
REMOTE_PATH="/storage/emulated/0/"
LOCAL_PATH="$HOME/Mobile_Phone_Rsync/"

# ============================================================
# åŠŸèƒ½å‡½æ•°
# ============================================================

# å¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: $(basename "$0") [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -r, --run      çœŸæ­£æ‰§è¡Œæ¨é€æ“ä½œ (é»˜è®¤ä»…ä¸ºæµ‹è¯•æ¨¡å¼)"
    echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "è¯´æ˜: è¯¥è„šæœ¬ä½¿ç”¨ SSH + Rsync æ¥åŒæ­¥æ•°æ® (PC -> æ‰‹æœº) ã€‚"
    echo "      é»˜è®¤é€šè¿‡ USB Rndis0 (USBå…±äº«ç½‘ç»œ) æ¨¡å¼è¿æ¥ï¼Œä»¥æé«˜ä¼ è¾“é€Ÿåº¦ï¼›å¦‚æœæœªè¿æ¥åˆ°æ‰‹æœºçš„ Rndis0 è®¾å¤‡ï¼Œåˆ™ä½¿ç”¨å¸¸è§„æ¨¡å¼ä½œä¸ºå›é€€ã€‚"
    echo "      é»˜è®¤å¼€å¯ Dry-runï¼Œä»…æ˜¾ç¤ºå°†è¦æ¨é€åˆ°æ‰‹æœºçš„æ–‡ä»¶ã€‚"
}

# è¯†åˆ«ç½‘ç»œç¯å¢ƒ
detect_network() {
    # æ‰‹æœºè¿è¡Œç”± MagiskSSH æ¨¡å—æä¾›çš„ OpenSSH ï¼Œä»…ç›‘å¬åœ¨ 127.0.0.1:22
    # 7743: æ‰‹æœºç«¯ç½‘å…³ç›‘å¬çš„ Inbound ç«¯å£(ç”¨äº USB Rndis0 é«˜é€Ÿæ¥å…¥)ï¼Œç”±æ‰‹æœºç«¯ç½‘å…³è½¬å‘è‡³ 127.0.0.1:22
    # 22  : é€šè¿‡ Tailscale åˆ†é…çš„åŸŸå/IP æ­£å¸¸è®¿é—®ï¼Œç”±æ‰‹æœºç«¯ç½‘å…³è½¬å‘è‡³ 127.0.0.1:22

    local dev_name
    dev_name=$(ip -o link show | awk -F': ' '{print $2}' | grep -E '^(enp[0-9a-z]+u[0-9]+|usb[0-9]+)' | head -n 1)

    if [ -n "$dev_name" ]; then
        local rndis_ip=$(ip route show dev "$dev_name" 2>/dev/null | grep 'default' | awk '{print $3}' | head -n 1)
        if [ -n "$rndis_ip" ]; then
            SSH_HOST="$rndis_ip"
            SSH_PORT="7743"
            echo "ğŸ”Œ [USB æ¨¡å¼] ç›®æ ‡: $SSH_HOST:$SSH_PORT"
            return 0
        fi
    fi

    SSH_HOST="oneplus12"
    SSH_PORT="22"
    echo "ğŸŒ [ç½‘ç»œæ¨¡å¼] ç›®æ ‡: $SSH_HOST:$SSH_PORT"
}

# æ ¸å¿ƒåŒæ­¥é€»è¾‘ (PC -> æ‰‹æœº)
do_push() {
    # æ‰‹æœºè¿è¡Œç”± MagiskSSH æ¨¡å—æä¾›çš„ Rsync

    local is_run_currently=$1
    local dry_run_flag="-n"
    
    if [ "$is_run_currently" = "true" ]; then
        dry_run_flag=""
        echo "ğŸš€ [æ­£å¼æ‰§è¡Œ] å¼€å§‹å‘æ‰‹æœº [æ¨é€] å¢é‡åŒæ­¥..."
    else
        echo "ğŸ” [æµ‹è¯•æ¨¡å¼] ä»…æ˜¾ç¤ºå·®å¼‚ï¼Œä¸ä¿®æ”¹æ‰‹æœºæ–‡ä»¶ (ä½¿ç”¨ -r çœŸæ­£æ‰§è¡Œ)"
    fi

    # æ£€æŸ¥æœ¬åœ°ç›®å½•
    if [ ! -d "$LOCAL_PATH" ]; then
        echo "âŒ é”™è¯¯: å¾…æ¨é€çš„æœ¬åœ°ç›®å½•ä¸å­˜åœ¨: $LOCAL_PATH"
        exit 1
    fi

    local excludes=(
        --exclude="Android/"
        --exclude=".thumbnails/"
        --exclude=".trashed-*"
        --exclude=".recycle"
        --exclude="cache/"
        --exclude=".git/"
        --exclude=".DS_Store"
    )

    # æ‰§è¡Œ rsync
    # -a: å½’æ¡£æ¨¡å¼, -h: äººç±»å¯è¯», -u: å¢é‡æ›´æ–°, -P: æ˜¾ç¤ºè¿›åº¦
    # --modify-window: è®¾ç½®ä¿®æ”¹æ—¶é—´(mtime)è¯¯å·®èŒƒå›´ (å•ä½: ç§’)
    # --omit-dir-times: é’ˆå¯¹ Android å­˜å‚¨ä¼˜åŒ–ï¼Œä¸å°è¯•åŒæ­¥ç›®å½•çš„ä¿®æ”¹æ—¶é—´
    rsync -ahuP $dry_run_flag \
        --stats \
        --modify-window=1 \
        --no-p --no-o --no-g --omit-dir-times \
        "${excludes[@]}" \
        -e "ssh -p $SSH_PORT -i $SSH_KEY" \
        "$LOCAL_PATH" \
        "$SSH_USER@$SSH_HOST:$REMOTE_PATH"

    # ç›´æ¥è®°å½•çŠ¶æ€å¹¶è¿”å›ï¼Œä¸åœ¨è¿™é‡Œæ‰“å°â€œä»»åŠ¡ç»“æŸâ€ï¼Œä¿æŒå‡½æ•°åŠŸèƒ½å•ä¸€
    local rsync_status=$?
    if [ $rsync_status -eq 0 ]; then
        echo "âœ¨ [æ¨é€]å®Œæˆã€‚"
    else
        echo "ğŸ’¥ [æ¨é€]å¤±è´¥ï¼Œè·³è¿‡åç»­æ­¥éª¤ã€‚è¯·æ£€æŸ¥æ‰‹æœºç«¯ SSH æ˜¯å¦å¯åŠ¨ï¼ŒUSB å…±äº«æ˜¯å¦æ‰“å¼€ / ç½‘ç»œæ˜¯å¦ç•…é€šã€‚"
    fi
    return $rsync_status
}

# åˆ·æ–°åª’ä½“åº“é€»è¾‘
refresh_media_store() {
    local is_run_currently=$1
    if [ "$is_run_currently" != "true" ]; then
        echo "â­ï¸  æµ‹è¯•æ¨¡å¼ä¸‹è·³è¿‡åª’ä½“åº“åˆ·æ–°ã€‚"
        return 0
    fi

    echo "ğŸ”„ æ­£åœ¨é€šçŸ¥æ‰‹æœºåˆ·æ–°åª’ä½“åº“..."
    # è¿œç¨‹æ‰§è¡Œ am broadcast å‘½ä»¤
    ssh -p "$SSH_PORT" -i "$SSH_KEY" "$SSH_USER@$SSH_HOST" "REMOTE_PATH=\"$REMOTE_PATH\" PATH=\$PATH:/system/bin sh -s" << 'EOF'
am broadcast -a android.intent.action.MEDIA_SCANNER_SCAN_FILE -d "file://$REMOTE_PATH" > /dev/null
if [ $? -eq 0 ]; then
    echo "âœ… æ‰‹æœºç«¯åˆ·æ–°å‘½ä»¤å·²æˆåŠŸ"
else
    echo "âš ï¸  æ‰‹æœºç«¯åˆ·æ–°è¿‡ç¨‹è¿”å›äº†éé›¶çŠ¶æ€"
fi
EOF
}

# ============================================================
# ä¸»å…¥å£
# ============================================================

main() {
    local run_rsync=false

    case "$1" in
        -r|--run)
            run_rsync=true
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        "")
            run_rsync=false
            ;;
        *)
            echo "âŒ é”™è¯¯: æœªçŸ¥å‚æ•° '$1'"
            show_help
            exit 1
            ;;
    esac

    # æ‰§è¡Œæµç¨‹
    detect_network
    do_push "$run_rsync" && \
        refresh_media_store "$run_rsync"
}

main "$@"
