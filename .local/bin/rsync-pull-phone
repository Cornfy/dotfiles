#!/bin/bash

# ============================================================
# é…ç½®åŒºåŸŸ
# ============================================================
SSH_USER="root"
SSH_KEY="$HOME/.ssh/id_ed25519_oneplus12"
REMOTE_PATH="/storage/emulated/0/"
LOCAL_PATH="$HOME/Mobile_Phone_Rsync/"

# ============================================================
# åŠŸèƒ½å‡½æ•°
# ============================================================

# å¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: $(basename "$0") [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -r, --run    çœŸæ­£æ‰§è¡ŒåŒæ­¥æ“ä½œ (é»˜è®¤ä»…ä¸ºæµ‹è¯•æ¨¡å¼)"
    echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "è¯´æ˜: è¯¥è„šæœ¬ä½¿ç”¨ SSH + Rsync æ¥åŒæ­¥æ•°æ® (PC -> æ‰‹æœº) ã€‚"
    echo "      é»˜è®¤é€šè¿‡ USB Rndis0 (USBå…±äº«ç½‘ç»œ) æ¨¡å¼è¿æ¥ï¼Œä»¥æé«˜ä¼ è¾“é€Ÿåº¦ï¼›å¦‚æœæœªè¿æ¥åˆ°æ‰‹æœºçš„ Rndis0 è®¾å¤‡ï¼Œåˆ™ä½¿ç”¨å¸¸è§„æ¨¡å¼ä½œä¸ºå›é€€ã€‚"
    echo "      é»˜è®¤å¼€å¯ Dry-runï¼Œä»…æ˜¾ç¤ºå°†è¦æ¨é€åˆ°æ‰‹æœºçš„æ–‡ä»¶ã€‚"
}

# è¯†åˆ«ç½‘ç»œç¯å¢ƒ
detect_network() {
    # æ‰‹æœºè¿è¡Œç”± MagiskSSH æ¨¡å—æä¾›çš„ OpenSSH ï¼Œä»…ç›‘å¬åœ¨ 127.0.0.1:22
    # 7743: æ‰‹æœºç«¯ç½‘å…³ç›‘å¬çš„ Inbound ç«¯å£(ç”¨äº USB Rndis0 é«˜é€Ÿæ¥å…¥)ï¼Œç”±æ‰‹æœºç«¯ç½‘å…³è½¬å‘è‡³ 127.0.0.1:22
    # 22  : é€šè¿‡ Tailscale åˆ†é…çš„åŸŸå/IP æ­£å¸¸è®¿é—®ï¼Œç”±æ‰‹æœºç«¯ç½‘å…³è½¬å‘è‡³ 127.0.0.1:22

    local dev_name
    dev_name=$(ip -o link show | awk -F': ' '{print $2}' | grep -E '^(enp[0-9a-z]+u[0-9]+|usb[0-9]+)' | head -n 1)

    if [ -n "$dev_name" ]; then
        local rndis_ip=$(ip route show dev "$dev_name" 2>/dev/null | grep 'default' | awk '{print $3}' | head -n 1)
        if [ -n "$rndis_ip" ]; then
            SSH_HOST="$rndis_ip"
            SSH_PORT="7743"
            echo "ğŸ”Œ [USB æ¨¡å¼] ç›®æ ‡: $SSH_HOST:$SSH_PORT"
            return 0
        fi
    fi

    SSH_HOST="oneplus12"
    SSH_PORT="22"
    echo "ğŸŒ [ç½‘ç»œæ¨¡å¼] ç›®æ ‡: $SSH_HOST:$SSH_PORT"
}

# åŒæ­¥æ ¸å¿ƒ(æ‰‹æœº -> PC)
do_sync() {
    # æ‰‹æœºè¿è¡Œç”± MagiskSSH æ¨¡å—æä¾›çš„ Rsync

    local is_run_currently=$1
    local dry_run_flag="-n"
    
    if [ "$is_run_currently" = "true" ]; then
        dry_run_flag=""
        echo "ğŸ“¥ [æ­£å¼æ‰§è¡Œ] å¼€å§‹ä»æ‰‹æœº[æ‹‰å–]å¢é‡åŒæ­¥..."
    else
        echo "ğŸ” [æµ‹è¯•æ¨¡å¼] ä»…æ˜¾ç¤ºå·®å¼‚ï¼Œä¸ä¿®æ”¹æ–‡ä»¶ (ä½¿ç”¨ -r çœŸæ­£æ‰§è¡Œ)"
    fi

    local excludes=(
        --exclude="Android/"
        --exclude=".thumbnails/"
        --exclude=".trashed-*"
        --exclude=".recycle"
        --exclude="cache/"
        --exclude=".git/"
        --exclude=".DS_Store"
    )

    # æ‰§è¡Œ rsync
    # -a: å½’æ¡£æ¨¡å¼, -h: äººç±»å¯è¯», -u: å¢é‡æ›´æ–°, -P: æ˜¾ç¤ºè¿›åº¦
    # --modify-window: è®¾ç½®ä¿®æ”¹æ—¶é—´(mtime)è¯¯å·®èŒƒå›´ (å•ä½: ç§’)
    rsync -ahuP $dry_run_flag \
        --stats \
        --modify-window=1 \
        --no-p --no-g --no-o --chmod=D755,F644 \
        "${excludes[@]}" \
        -e "ssh -p $SSH_PORT -i $SSH_KEY" \
        "$SSH_USER@$SSH_HOST:$REMOTE_PATH" \
        "$LOCAL_PATH"

    if [ $? -eq 0 ]; then
        echo "âœ¨ [æ‹‰å–]å®Œæˆã€‚"
    else
        echo "ğŸ’¥ [æ‹‰å–]å¤±è´¥ã€‚è¯·æ£€æŸ¥æ‰‹æœºç«¯ SSH æ˜¯å¦å¯åŠ¨ï¼ŒUSB å…±äº«æ˜¯å¦æ‰“å¼€ / ç½‘ç»œæ˜¯å¦ç•…é€šã€‚"
        exit 1
    fi
}

# ============================================================
# ä¸»å…¥å£
# ============================================================

main() {
    local run_rsync=false

    # è§£æå‚æ•°
    case "$1" in
        -r|--run)
            run_rsync=true
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        "")
            # é»˜è®¤ä¸ä¼ å‚æ•°æ—¶çš„é€»è¾‘ï¼šæ‰§è¡Œæµ‹è¯•
            run_rsync=false
            ;;
        *)
            echo "âŒ é”™è¯¯: æœªçŸ¥å‚æ•° '$1'"
            show_help
            exit 1
            ;;
    esac

    # ç¡®ä¿æœ¬åœ°ç›®å½•
    mkdir -p "$LOCAL_PATH"

    # æ‰§è¡Œæµç¨‹
    detect_network
    do_sync "$run_rsync"
}

main "$@"
